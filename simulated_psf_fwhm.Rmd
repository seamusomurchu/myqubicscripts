---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.6.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import qubic.sb_fitting as sbfit
import matplotlib.pyplot as plt
import numpy as np
from scipy.interpolate import griddata
import qubic.fibtools as ft
import scipy.optimize as opt
from scipy.signal import chirp, find_peaks, peak_widths
import scipy.misc
```

```{python}
"""load psfs"""
"""load and plot simulation data"""
psflist = np.array([6, 37, 50, 58, 76, 93])

psfdata = np.zeros([6, 3, 251001])
for i, tes in enumerate(psflist):
    data = np.loadtxt('/home/james/TESonSky/psf{}.dat'.format(tes), skiprows=1)
    psfdata[i,:,:] = data.T

plt.figure(figsize=(10,10))
for i , tes in enumerate(psflist):
    plt.subplot(2,3,i+1)
    plt.scatter(psfdata[i,0,:], psfdata[i,1,:]+50, c=psfdata[i,2,:])
    plt.axis('equal')
    #plt.plot(peaks[i, 0, :], peaks[i, 1, :], 'r.')
    plt.title('Sim data TES {}'.format(tes))
```

```{python}
"""make a meshgrid from the psf data to make fits"""

def makemeshgrid(psfdata, meshsize):
    x = np.linspace(min(psfdata[0,:]), max(psfdata[0,:]), meshsize)
    y = np.linspace(min(psfdata[1,:]), max(psfdata[1,:]), meshsize)

    X,Y = np.meshgrid(x, y)

    # Interpolate (x,y,z) points [mat] over a normal (x,y) grid [X,Y]
    #   Depending on your "error", you may be able to use other methods
    Z = griddata((psfdata[0,:], psfdata[1,:]), psfdata[2,:], (X,Y), method='nearest')

    #plt.pcolormesh(X,Y,Z)
    #plt.show()
    return Z

meshsize = 101
psfmesh = np.zeros([6, meshsize, meshsize])
for i, tes in enumerate(psflist):
    psfmesh[i,:,:] = makemeshgrid(psfdata[i], meshsize)



x = np.linspace(min(psfdata[0,0,:]), max(psfdata[0,0,:]), meshsize)
y = np.linspace(min(psfdata[0,1,:]), max(psfdata[0,1,:]), meshsize)


```

```{python}
x = np.linspace(min(psfdata[0,0,:]), max(psfdata[0,0,:]), meshsize)
y = np.linspace(min(psfdata[0,1,:]), max(psfdata[0,1,:]), meshsize)

print(psfdata.shape, psfmesh.shape, x.shape, min(x), max(x), min(y), max(y))
```

```{python}
plt.figure(figsize=(16,11))
for i, tes in enumerate(psflist):

    plt.subplot(2,3,i+1)
    
    plt.imshow(psfmesh[i,:,:], aspect='equal',
        extent=[np.min(x), np.max(x), np.min(y), np.max(y)])
    plt.axis('equal')
    plt.title('Sim data TES {}'.format(tes))
```

```{python}
# Make a line with "num" points...
x0, y0 = 15, 21 # These are in _pixel_ coordinates!!
x1, y1 = 85, 91
# x0, y0 = 40, 98 # These are in _pixel_ coordinates!!
# x1, y1 = 65, 98
num = 101
x, y = np.linspace(x0, x1, num), np.linspace(y0, y1, num)
# Extract the values along the line
zi = psfmesh[i,:,:][x.astype(np.int), y.astype(np.int)]
zi = scipy.ndimage.map_coordinates(np.transpose(psfmesh[i,:,:]), np.vstack((x,y)))

plt.figure(figsize=(16,8))
plt.subplot(1,2,1)
plt.imshow(psfmesh[5,:,:], aspect='equal')
plt.plot([x0, x1], [y0, y1], 'ro-')

# #set up axis for second plot
azi = np.linspace(min(psfmesh[4,:,0]), max(psfmesh[4,:,0]), len(zi))
# newazi = np.array([])
# for i, z in enumerate(azi):
#     #print(i, z)
#     if (i>x0) and (i<x1):
        
#         newazi = np.append(newazi, z)
        
#newazi = np.linspace(min(newazi), max(newazi), len(zi))

plt.subplot(1,2,2)
plt.plot(azi, zi)
#plt.plot(zi)
#print(newazi)
#xticks(newazi)



peaks, _ = find_peaks(zi, prominence=0.2)
results_half = peak_widths(zi, peaks, rel_height=0.5)
#plt.plot(peaks, zi[peaks], "x")
#plt.hlines(*results_half[1:], color="C2")
#print(zi.shape, peaks.shape, results_half)
#print(peaks, zi, zi.shape, azi.shape)
print(*results_half[1:])
print(results_half)
#print(azi[peaks])
plt.plot(azi[peaks], zi[peaks], "x")
plt.plot(azi[peaks], results_half[1], '_', mew=3, markersize=12)
#plt.hlines(results_half[1], results_half[2], results_half[3], color="C2")
```

```{python}
"""IF 0.396 deg/pt"""
#print fwhm from points
print(results_half[0])
#print fhhm * 0.4deg/pt
print("FWHM in deg ", results_half[0] * 0.396 ) #= fwhm in deg
```

```{python}
azi = np.linspace(min(psfdata[5,0,:]), max(psfdata[5,0,:]), len(zi))
print(len(zi), "length zi cut")
print(max(azi) - min(azi), "degrees")
print( num, "points")
print((max(azi) - min(azi))/num, "degrees/point in whole image")
print(((max(azi) - min(azi))/num) * len(zi), "degrees for cut length")

print("FWHM in deg ", results_half[0] * ((max(azi) - min(azi))/num) ) #= fwhm in deg
```

```{python}
"""The same but in degress for SPIE plot"""
tes76 = 5

azmin = min(psfdata[tes76,0,:])
azmax = max(psfdata[tes76,0,:])
elmin = min(psfdata[tes76,1,:])
elmax = max(psfdata[tes76,1,:])

X = np.linspace(azmin, azmax, 101)
Y = np.linspace(elmax, elmin, 101)

# x0, y0 = 50, 158# These are in _pixel_ coordinates!! in DEGREES
# x1, y1 = 175, 32
x0, y0 = 25, 79# These are in _pixel_ coordinates!! in DEGREES
x1, y1 = 81, 22

plt.figure(figsize=(16,12))
plt.subplot(1,2,1)
plt.imshow(psfmesh[tes76,:,:], aspect='equal')
plt.grid(True)
plt.plot([x0, x1], [y0, y1], 'ro-')


plt.subplot(1,2,2)
plt.imshow(psfmesh[tes76,:,:], aspect='equal', extent=[azmin, azmax, elmin, elmax])
plt.grid(True)
plt.plot([X[x0], X[x1]], [Y[y0], Y[y1]], 'ro-')

xr = np.linspace(x0, x1, x1-x0)
yr = np.linspace(y0, y1, x1-x0)
zi = psfmesh[tes76,:,:][xr.astype(np.int), yr.astype(np.int)]
zi = scipy.ndimage.map_coordinates(np.transpose(psfmesh[tes76,:,:]), np.vstack((xr,yr)))
azi = np.linspace(X[x0], X[x1], len(zi))

peaks, _ = find_peaks(zi, prominence=0.2)
results_half = peak_widths(zi, peaks, rel_height=0.5)
print(results_half)

degpt = (azmax - azmin)/101
print(degpt)

plt.figure(figsize=(16,8))
plt.plot(azi, zi, label="Cut", lw=4)
plt.plot(azi[peaks], zi[peaks], "x", label="Peaks", mew=5, ms=10)
plt.plot(azi[peaks], results_half[1], '_', mew=5, ms=10, 
         label="FWHM = {:3.3}$^\circ$".format(results_half[0][1]*degpt))
plt.plot(azi[peaks], zi[peaks], "x", mew=5, ms=10, 
         label="Peak Sep {:3.2}$^\circ$, {:3.2}$^\circ$".format(azi[peaks][1]-azi[peaks][0], azi[peaks][1]-azi[peaks][2]))

plt.legend(loc='upper left', fontsize=15)

```

```{python}
print(azi.shape, x.shape)
print(x)
```

```{python}
"""Reapeat at double resolution"""
meshsize = 201
psfmesh = np.zeros([6, meshsize, meshsize])
for i, tes in enumerate(psflist):
    psfmesh[i,:,:] = makemeshgrid(psfdata[i], meshsize)



x = np.linspace(min(psfdata[0,0,:]), max(psfdata[0,0,:]), meshsize)
y = np.linspace(min(psfdata[0,1,:]), max(psfdata[0,1,:]), meshsize)

```

```{python}
plt.figure(figsize=(16,11))
for i, tes in enumerate(psflist):

    plt.subplot(2,3,i+1)
    
    plt.imshow(psfmesh[i,:,:], aspect='equal',
        extent=[np.min(x), np.max(x), np.min(y), np.max(y)])
    plt.axis('equal')
    plt.title('Sim data TES {}'.format(tes))
```

```{python}
# Make a line with "num" points...
x0, y0 = 30, 42 # These are in _pixel_ coordinates!!
x1, y1 = 150, 162

num = 101
x, y = np.linspace(x0, x1, num), np.linspace(y0, y1, num)
# Extract the values along the line
zi = psfmesh[i,:,:][x.astype(np.int), y.astype(np.int)]
zi = scipy.ndimage.map_coordinates(np.transpose(psfmesh[i,:,:]), np.vstack((x,y)))

plt.figure(figsize=(16,8))
plt.subplot(1,2,1)
plt.imshow(psfmesh[5,:,:], aspect='equal')
plt.plot([x0, x1], [y0, y1], 'ro-')

plt.subplot(1,2,2)
plt.plot(azi, zi)

peaks, _ = find_peaks(zi, prominence=0.2)
results_half = peak_widths(zi, peaks, rel_height=0.5)

print(*results_half[1:])
print(results_half)
#print(azi[peaks])
plt.plot(azi[peaks], zi[peaks], "x")
plt.plot(azi[peaks], results_half[1], '_', mew=3, markersize=12)
#plt.hlines(results_half[1], results_half[2], results_half[3], color="C2")
```

```{python}
azi = np.linspace(min(psfdata[5,0,:]), max(psfdata[5,0,:]), len(zi))
print(len(zi), "length zi cut")
print(max(azi) - min(azi), "degrees")
print( num, "points")
print((max(azi) - min(azi))/num, "degrees/point in whole image")
print(((max(azi) - min(azi))/num) * len(zi), "degrees for cut length")

print("FWHM in deg ", results_half[0] * ((max(azi) - min(azi))/num) ) #= fwhm in deg
```

```{python}
n=8
print(np.degrees(2e-3 / ((n -1) * 14e-3)))
```

```{python}
"""Calc FWHM for TES 76"""
x0, y0 = 6, 200 # These are in _pixel_ coordinates!!
x1, y1 = 200, 7

num = 101
x, y = np.linspace(x0, x1, num), np.linspace(y0, y1, num)
# Extract the values along the line
zi = psfmesh[4,:,:][x.astype(np.int), y.astype(np.int)]
zi = scipy.ndimage.map_coordinates(np.transpose(psfmesh[4,:,:]), np.vstack((x,y)))

plt.figure(figsize=(16,8))
plt.subplot(1,2,1)
plt.imshow(psfmesh[4,:,:], aspect='equal')
plt.plot([x0, x1], [y0, y1], 'ro-')

plt.subplot(1,2,2)
plt.plot(azi, zi)

peaks, _ = find_peaks(zi, prominence=0.2)
results_half = peak_widths(zi, peaks, rel_height=0.5)

print(*results_half[1:])
print(results_half)
#print(azi[peaks])
plt.plot(azi[peaks], zi[peaks], "x")
plt.plot(azi[peaks], results_half[1], '_', mew=3, markersize=12)
```

```{python}
print(len(zi), "length zi cut")
print(max(azi) - min(azi), "degrees")
print( num, "points")
print((max(azi) - min(azi))/num, "degrees/point in whole image")
print(((max(azi) - min(azi))/num) * len(zi), "degrees for cut length")

print("FWHM in deg ", results_half[0] * ((max(azi) - min(azi))/num) ) #= fwhm in deg
```

```{python}

```

```{python}

```
